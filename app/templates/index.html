<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extract Website Text</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <img
        src="{{ url_for('static', filename='images/scrapegoat-logo.png') }}"
        alt="ScrapeGoat Logo"
        class="logo"
      />
    </header>

    <form method="POST" id="scrape-form">
      <h1>Scrapegoat</h1>
      <input
        type="text"
        name="url"
        placeholder="Enter URL (e.g., example.com)"
        required
      />
      <button id="submit-btn" type="submit">Extract</button>
    </form>

    {# Only show progress bar/status if crawl is ongoing! #} {% if crawl_status
    and ("finished" not in crawl_status.lower()) and ("error" not in
    crawl_status.lower()) %}
    <div class="section">
      <div class="status" id="crawl-status">{{ crawl_status }}</div>
      <div
        class="progress-bar-bg"
        style="
          height: 18px;
          background: #eee;
          border-radius: 8px;
          margin-top: 10px;
        "
      >
        <div
          id="progress-bar"
          style="
            height: 100%;
            background: #37a;
            width: 0%;
            border-radius: 8px;
            transition: width 0.3s;
          "
        ></div>
      </div>
    </div>

    <!-- ==== AJAX Polling Script (SINGLE VERSION) ==== -->
    <script>
      const taskId = "{{ task_id or '' }}";
      function pollStatus() {
        if (!taskId) return;
        const statusEl = document.getElementById("crawl-status");
        const progressEl = document.getElementById("progress-bar");
        fetch(`/status/${taskId}`)
          .then((r) => r.json())
          .then((data) => {
            statusEl.textContent = data.status || "Waiting...";
            if (
              data.progress &&
              data.progress.percent !== undefined &&
              progressEl
            ) {
              progressEl.style.width = data.progress.percent + "%";
            }
            if (!data.finished) {
              setTimeout(pollStatus, 2000);
            } else {
              // Show 100% on completion
              if (progressEl) progressEl.style.width = "100%";
              statusEl.textContent = (data.status || "") + " (Done)";
              setTimeout(() => window.location.reload(), 1200);
            }
          });
      }
      if (taskId && document.getElementById("crawl-status")) {
        pollStatus();
      }
    </script>
    {% endif %} {% if text %}
    <div class="section">
      <h3>Extracted Page Text</h3>
      <div class="text-content" id="text-output">
        {{ text.replace("\n", "<br />") | safe }}
      </div>
    </div>
    {% endif %} {% if scraped_files.images or scraped_files.documents or
    scraped_files.others %}
    <div class="section">
      <h3>Scraped Files</h3>
      <div class="file-category-list">
        <!-- (images, documents, others, unchanged) -->
        <!-- ... -->
      </div>
    </div>
    {% endif %}
  </body>
</html>
